<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Array equality benchmark</title>
	</head>
	<script type="module">
		import isEqual from "https://unpkg.com/lodash-es@4.17.21/isEqual.js";
		import shallowEqual from "https://unpkg.com/react-redux@8.1.3/es/utils/shallowEqual.js";
		import { shallowEqualArrays } from "https://unpkg.com/shallow-equal@3.1.0/dist/index.modern.mjs";
		import { Bench } from "https://unpkg.com/tinybench@2.3.1/dist/index.js";

		const DEFAULT_ARRAY_LENGTH = 1_000;

		const getOpsPerSec = (task) =>
			task.result.error ? "NaN" : Math.round(task.result.hz);

		const getSlowerBy = (index, array) => {
			if (index === 0) return "N/A";

			const topResult = getOpsPerSec(array[0]);
			const currentResultResult = getOpsPerSec(array[index]);

			return `${(100 - (currentResultResult / topResult) * 100).toFixed(2)}%`;
		};

		const getTable = (bench, testType) => {
			return bench.tasks
				.toSorted((a, b) => b.result.hz - a.result.hz)
				.reduce((result, task, index, array) => {
					if (task.result) {
						if (task.result.error) {
							throw task.result.error;
						}

						const opsPerSecond = getOpsPerSec(task);

						const slowerBy = getSlowerBy(index, array);

						const avgTimeMs = task.result.error
							? "NaN"
							: Number(task.result.mean.toFixed(4));

						result[`${index + 1}. ${task.name}`] = {
							// rank: index + 1,
							"ops/sec": opsPerSecond,
							slowerBy,
							// type: testType,
							"average time (ms)": avgTimeMs,
							// Margin: task.result.error
							// 	? "NaN"
							// 	: `\xb1${task.result.rme.toFixed(2)}%`,
							// samples: task.result.error ? "NaN" : task.result.samples.length,
						};
					}

					return result;
				}, {});
		};

		const functions = [isEqual, shallowEqual, shallowEqualArrays];

		const getArrayLength = () => {
			const form = document.getElementById("form");

			const formData = new FormData(form);
			const length = formData.get("length");

			return length ? Number(length) : DEFAULT_ARRAY_LENGTH;
		};

		const getTests = () => {
			const arrayLength = getArrayLength();

			const array = Array.from(Array(arrayLength).keys());

			return [
				{
					type: "Equal, same ref",
					data: [array, array],
				},
				{
					type: "Equal, different ref",
					data: [[...array], [...array]],
				},
				{
					type: "Not equal, at end",
					data: [array.concat(1), array],
				},
				{
					type: "Not equal, at start",
					data: [[1, ...array], array],
				},
				{
					type: "Not equal, mid",
					data: [
						array
							.slice(0, Math.floor(array.length / 2))
							.concat(1)
							.concat(array.slice(Math.floor(array.length / 2))),
						array,
					],
				},
			];
		};

		const benchmark = async () => {
			const allTests = getTests();

			console.log("Running...");

			for await (const test of allTests) {
				const bench = new Bench();

				functions.forEach((func) => {
					const [obj1, obj2] = test.data;
					const taskName = func.name;

					const task = () => {
						func(obj1, obj2);
					};

					bench.add(taskName, task);
				});

				await bench.warmup(); // make results more reliable, ref: https://github.com/tinylibs/tinybench/pull/50

				await bench.run();

				// console.group();
				console.info(test.type);
				console.table(getTable(bench));
				console.info("");
				console.info("");
				// console.groupEnd();
			}

			console.log("Done.");
		};

		form.addEventListener("submit", (event) => {
			event.preventDefault();

			benchmark();
		});
	</script>
	<body>
		<h3>Open DevTools console to see results</h3>
		<form id="form">
			<label for="ARRAY_LENGTH">Array length</label>
			<input id="ARRAY_LENGTH" name="length" type="number" value="1000" />
			<button type="submit">Run</button>
		</form>
	</body>
</html>
